
<!DOCTYPE html>
<html lang="en-us">
<head>

  
  <meta charset="UTF-8">
  <title>
    user-influenced os commands are still considered harmful | kel.bz
  </title>


  
  <meta name="viewport" content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1">

  
  <link rel="canonical" href="https://kel.bz/post/javaexec/"/>

  
  <link rel="stylesheet" href="/css/sanitize.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" href="/css/highlight_monokai.css">
  <link rel="stylesheet" href="/css/theme.css">
  <link rel="stylesheet" href="/css/custom.css">
  
  
  <link href="https://kel.bz//index.xml" rel="alternate" type="application/rss+xml" title="kel.bz" />
  <link href="https://kel.bz//index.xml" rel="feed" type="application/rss+xml" title="kel.bz" />

  
  


</head>



<body>
<div class="container">

  
  <header role="banner">
    <div class="row gutters">
      <div id="site-title" class="col span_6">
        <h1><a href="https://kel.bz/">kel.bz</a></h1>
        
      </div>
      <div id="social" class="col span_6">
        <ul>
          <li><a href="/about/me">about kel.bz</a></li>
          <li><a href="https://twitter.com/kelbyludwig" target="_blank">twitter</a></li>
          
          <li><a href="https://github.com/kelbyludwig" target="_blank">github</a></li>
          <li><a href="https://kel.bz//index.xml" type="application/rss+xml" target="_blank">rss</a></li>
        </ul>
      </div>
    </div>
  </header>


  
  <main id="single" role="main">
    <div class="article-header">
      <h1>user-influenced os commands are still considered harmful</h1>
      <div class="meta">
        Dec 6, 2016 &nbsp;
        
      </div>
    </div>
    <article>
      <h1 id="more-of-the-same-sorta">more of the same (sorta)</h1>
<p>Its pretty standard advice to avoid using user-input within code that executes
operating system commands. However, most of that advice tends to revolve around
how dangerous it is for a user to provide the <em>command</em> to execute and I have
not seen (good) advice on whether other parts of a command (e.g. flags, flag
parameters) are safe to be user-controlled.</p>
<p>Command injection vulnerabilities do not necessarily require special shell directives or
user-controlled commands. This form of command injection is
straightforward and has had <a href="https://www.owasp.org/index.php/Command_injection">plenty written about
it</a> so I will focus on
less obvious examples.</p>
<p>Consider the following code snippet that I'm borrowing from an <a href="https://www.owasp.org/index.php/Command_injection_in_Java">OWASP page on
command injection</a>:</p>
<pre><code>Runtime rntime = Runtime.getRuntime();
Process proc = rntime.exec(&quot;find&quot; + &quot; &quot; + args[0]);
</code></pre><p>The page claims &ldquo;it is not possible to inject additional commands&rdquo; so it must
be secure! However, compiling the full Java file and running <code>java Example1 &quot;bad -exec cat {} +&quot;</code> on a Linux machine modifies the command being executed. A
program that originally listed file names matching the user-supplied argument
is now a program that <em>prints the contents</em> of the user-supplied file.</p>
<p>What about <code>tar</code>? Consider the following two code snippets:</p>
<pre><code>String cmd = &quot;tar tf &quot; + userControlledFilename;
Process proc = Runtime.getRuntime().exec(cmd);
</code></pre><pre><code>String[] cmdArray = new String[3];
cmdArray[0] = &quot;tar&quot;;
cmdArray[1] = &quot;tf&quot;;	
cmdArray[2] = userControlledFilename;
Process proc = Runtime.getRuntime().exec(cmdArray);
</code></pre><p>Are they safe? In short the answer is &ldquo;no&rdquo; because user-controlled
<code>tar</code> flags can lead to command injection. The following example
will execute <code>echo hello</code> (the <code>tar</code> version may affect results):</p>
<pre><code>tar tf file.tar --checkpoint=1 --checkpoint-action=exec=&quot;echo hello&quot;
</code></pre><p>The other interesting property of <code>Runtime.exec</code> is its behavior depends
on how its called and how its arguments are passed. The following Java
program demonstrates this (I use <code>gtar</code> as a GNU tar alias on OS X):</p>
<pre><code>// Full file here: https://gist.github.com/kelbyludwig/afb1755af190bb9fe66145b6a1706d76

//Executes a local script.
//String cmd = &quot;gtar tf file.tar --checkpoint=1 --checkpoint-action=exec=evil.sh&quot;;

//In some versions, GNU tar runs the checkpoint action with bash.
//String cmd = &quot;gtar tf file.tar --checkpoint=1 --checkpoint-action=exec={echo,test0}&quot;;
        
//GNU tar seperates on spaces, tabs, and newlines and `exec` seperates on spaces.
//String cmd = &quot;gtar tf file.tar --checkpoint=1 --checkpoint-action=exec=echo\ttest0&quot;;

//Test 1: Does not execute echo command
String cmd = &quot;gtar tf file.tar --checkpoint=1 --checkpoint-action=exec=\&quot;echo test1\&quot;&quot;;
System.out.println(&quot;TEST1:&quot;);
Process proc1 = Runtime.getRuntime().exec(cmd);
readOutput(proc1);

//Test 2: Executes echo command
String[] cmdArray = new String[5];
cmdArray[0] = &quot;gtar&quot;;
cmdArray[1] = &quot;tf&quot;;    
cmdArray[2] = &quot;file.tar&quot;;
cmdArray[3] = &quot;--checkpoint=1&quot;;
cmdArray[4] = &quot;--checkpoint-action=exec=\&quot;echo test2\&quot;&quot;;
System.out.println(&quot;TEST2:&quot;);
Process proc2 = Runtime.getRuntime().exec(cmdArray);
readOutput(proc2);

//Test 3: Does not execute echo command
cmdArray = new String[2];
cmdArray[0] = &quot;gtar&quot;;
cmdArray[1] = &quot;tf file.tar --checkpoint=1 --checkpoint-action=exec=\&quot;echo test3\&quot;&quot;;
System.out.println(&quot;TEST3:&quot;);
Process proc3 = Runtime.getRuntime().exec(cmdArray);
readOutput(proc3);
</code></pre><p>This produces interesting results I would like to point out. Suppose
everything after <code>/usr/local/bin/gtar tf</code> was user-controlled. First, I find it
interesting that Test 2 does executes <code>echo</code> and Test 3 does not. I have some
suspicions on why this is but I need to poke through OpenJDK and figure that
out.  Second, I have included comments on interesting behaviors of
<code>Runtime.exec</code>'s method of parsing its parameters. Depending on the context,
differences in input parsing could lead to input validation bypasses (and
subsequently command injection).</p>
<h1 id="in-conclusion">in conclusion&hellip;</h1>
<p><code>Runtime.exec</code> is (still) unsafe for user-controlled input! I imagine this is
not specific to Java or <code>Runtime.exec</code> either. Code that constructs OS commands
using user-input is scary and error-prone. It should be avoided!</p>
<p>If there are not high-level and secure libraries to perform a task without
resorting to OS-level commands I recommend coming up with a solution that
avoids using user-controlled input in that command all together. Shell escaping
is <a href="https://lf.lc/CVE-2016-4991.txt">too fragile</a> and should be avoided as
well.</p>

      
      
      
    </article>
    


  </main>
  
  <nav class="pagination-single">
    
      <span class="previous">&larr; <a href="https://kel.bz/post/signal/" rel="prev">why signal is well-designed</a></span>
    
    
      <span class="next"><a href="https://kel.bz/post/lattices/" rel="next">the ggh cryptosystem</a> &rarr;</span>
    
  </nav>


  
  <footer role="contentinfo">
    <div style="text-align:center;">
      <img src="https://kel.bz/profile.jpg" width="64" height="64"><br>
      written by kelby ludwig
    </div>
  </footer>


</div>

<script src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



</body>
</html>

